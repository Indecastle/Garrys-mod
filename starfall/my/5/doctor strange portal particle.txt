--@name Doctor Strange portal particle
--@author
--@client


local maxRadius = 40
local radiusVel = 1
local angVel = 0.4

local startFor = 5
local maxFor = 20

-------------------------------------------------

--if player() ~= owner() then return end

local emitter = nil;
local degree = 9999
local radK = 0;
local radius = 0
local radiusMove = -1


--local m = material.load("effects/spark")
local m = material.create("UnlitGeneric")
m:setTexture("$basetexture","effects/spark") -- effects/spark

local VertexAlpha= false
local VertexColor= true
local AlphaTest= true
local Additive= true
local Translucent= false

local flags = 
    (VertexColor and 16 or 0) +
    (VertexAlpha and 32 or 0) +
    (Additive and 128 or 0) +
    (AlphaTest and 256 or 0) +
    (Translucent and 2097152 or 0)

if flags ~= 0 then
    m:setInt("$flags",  
        flags)    
end


function rain()
    local x =  radius * math.cos(degree)
    local y = -radius * math.sin(degree)
    local localPos = Vector(0, x, y)
    local pos = chip():localToWorld(Vector(0,0,maxRadius+10) + localPos)
    local vel, _ = localToWorld(localPos,
            Angle(0,0,0),
            Vector(0,0,0),
            chip():getAngles() + Angle(0,math.rand(-20,20),-90))
    
    local part = emitter:add( m, pos, 2+5*radK, 0, 10*radK, 10*radK, 255, 0, 0.5 ) -- Create a new particle at pos
    if ( part ) then
        part:setCollide(true)
        --part:setBounce(1)
        part:setColor(Color(255,200,0))
        --part:setGravity( Vector( 0, 0, -20 ) ) -- Gravity of the particle
        part:setVelocity( vel:getNormalized() * (100 * radK + 40) ) -- Initial velocity of the particle
    end
end

function startRain()
    radius = radius + radiusMove * radiusVel
    if radius > maxRadius then radius = maxRadius end
    if radius <= 0 then radius = 0 return end
    radK = radius / maxRadius
    
    for i=0, (startFor + maxFor*radK) do
        degree = (degree + angVel + math.rand(0,0.5))
        if degree > (2*math.pi) then
            degree = degree % (2*math.pi)
            if (emitter) then emitter:destroy() end
            emitter = particle.create(Vector(), false) -- Particle emitter in this position
        end
        
        rain()
    end
    --emitter:destroy()
end

timer.create("rain", 0.05, 0, function()
--hook.add("think", "", function()
    startRain()
    
end)



hook.add("inputPressed", "kk", function(button)
    if button == MOUSE.MOUSE1 then          
        radiusMove = 1
    end
end)

hook.add("inputReleased", "kk", function(button)
    if button == MOUSE.MOUSE1 then          
        radiusMove = -1
    end
end)
