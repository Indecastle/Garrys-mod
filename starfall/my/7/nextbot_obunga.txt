--@name NextBot 2
--@author
--@shared



local Radius = 10000
local Speed = 500

local img = "obunga"
local size = 300

local IsGivingDamage = false


local URLS = {
    rikka_1 = "https://i.imgur.com/xdOEuic.png",
    rikka_2 = "https://i.imgur.com/qSiOCZH.jpg",
    rikka_ch = "https://i.imgur.com/9UtATPQ.gif",
    rikka_s = "https://cdn.discordapp.com/attachments/510528712320483329/711301069413679154/received_1790417730979994.jpeg",
    rikka_c = "https://i.imgur.com/5139yCi.jpg",
    rikka_f = "https://anime-planet.com/images/characters/rikka-takanashi-43640.jpg",
    horny = "https://media.discordapp.net/attachments/542043404629180417/849195384470503444/paLNxVWlfEM.png",
    malina_booba = "https://media.discordapp.net/attachments/854459216839049267/854459668261109790/O2NFX9U5dT8.jpg",
    malina_r = "https://media.discordapp.net/attachments/854459216839049267/854459668696793148/Prinz_Eugen.png",
    
    obunga = "https://i.imgur.com/wEBb6mG.png",
    custom = nil
}


local Killer


if SERVER then
    
    local players = find.allPlayers()

    local Killer = nextbot.create(chip():getPos(), "models/Lamarr.mdl")
    Killer:setColor(Color(0,0,0,0))
    
    Killer:setMoveSpeed(Speed)
    Killer:setAcceleration(Speed)
    Killer:setDeceleration(0)
    
    
    function gethead(ent)
        if ent:lookupBone("ValveBiped.Bip01_Head1") then
            local pos = ent:getBonePosition(ent:getHitBoxBone(0, 0))
            return pos
        end
        return ent:localToWorld(ent:obbCenter())
    end
    
    function isValidFindPlayer(ent)
        local nvars = ent:getNWVarTable()
        return ent ~= nil and ent:isValid() and ent:isValidPhys()
            and (ent:isPlayer() and ent:isAlive() and !ent:hasGodMode() and (nvars == nil or !nvars["_Kyle_Buildmode"])
                or ent:isNPC()) 
    end
    
    function isValidPlayer(ent)
        return ent ~= nil and ent:isValid() and ent:isValidPhys()
    end
    
    local closestPlayer;
    
    
    timer.create("findPlayer", 0.1, 0, function()
        if Killer ~= nil and Killer:isValid() then
            
            local validPlayers = find.allPlayers(function(e)
                return e:getPos():getDistance(Killer:getPos()) < Radius 
                        and isValidFindPlayer(e)
            end)
            
            validPlayers = find.sortByClosest(validPlayers, Killer:getPos())
            closestPlayer = #validPlayers ~= nil and validPlayers[1] or nil
        else
            closestPlayer = nil
        end
    end)
    
    
    timer.create("jump", 2, 0, function()
        if Killer ~= nil and Killer:isValid() and isValidPlayer(closestPlayer) then
            Killer:jump()
        end
    end)
    
    
    timer.create("fun", 0.1, 0, function()
        if Killer ~= nil and Killer:isValid() and isValidPlayer(closestPlayer) then
            Killer:setGotoPos(closestPlayer:getPos())
            
            if IsGivingDamage then
                if Killer:getPos():getDistance(closestPlayer:getPos()) <= 100 then
                        closestPlayer:applyDamage(100000, Killer, Killer)
                end
            end
        end
    end)
    
    
    hook.add("ClientInitialized", "cl_init", function(ply)
        net.start("init")
        net.writeEntity(Killer)
        net.send(ply)
    end)
    
    return
end



net.receive("init", function(len)
    net.readEntity(function(ent)
        if ent==nil then error("Failed to get Hologram!") end
        Killer = ent
    end)
end)



local screen = holograms.create(chip():localToWorld(Vector(0, 0, 5)), chip():getAngles(), "models/holograms/plane.mdl")


hook.add("think", "", function()
    --local d = -eyeVector()
    local d = (player():getEyePos() - screen:getPos()):getNormalized()
    local eyeAngle = d:getAngle() + Angle(90,0,0)
    eyeAngle = eyeAngle:setP(90)
    screen:setAngles(eyeAngle)
    
       
    if isValid(Killer) then
        screen:setPos(Killer:getPos())
    end
end) 




URL = URLS[img]

if not hasPermission("material.urlcreate", URL) then
    cantload()
    return
end

local mat = material.create("UnlitGeneric")

mat:setInt("$flags", 256)

mat:setTextureURL("$basetexture", URL, function(m, u, w, h, l)
    if m == nil then return end

    local ratio = w / h

    local sh = size
    local sw = sh * ratio
    screen:setSize(Vector(sh, sw, 1))
    
    local x,y,w,h;
    x = m:getWidth() / 4 
    y = 0 
    w = m:getWidth() / 2 
    h = m:getHeight() / 2

    l(x, y, w, h)
    
    screen:setMaterial("!" .. mat:getName())
end)
